<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>唤起目标页面并触发插件</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body { font-family: Arial, sans-serif; padding:20px; }
    pre { background:#f4f6f8; padding:10px; border-radius:6px; }
    button { padding:8px 12px; border-radius:6px; border:none; background:#2563eb; color:#fff; cursor:pointer; }
  </style>
</head>
<body>
  <h2>正在打开目标页面并请求插件执行</h2>
  <p>目标： <code id="target">{{ target_url }}</code></p>
  <p>若浏览器阻止弹窗，请允许或手动打开目标页面。</p>

  <button id="openBtn">打开并触发插件（推荐先点击）</button>

  <h3>发送的 payload（调试用）</h3>
  <pre id="payload"></pre>

  <h3>接收回执（如果有）</h3>
  <pre id="reply"></pre>

  <script>
    const payload = {{ payload_json|safe }};
    const targetUrl = "{{ target_url }}";
    const allowedOrigin = "{{ allowed_origin }}"; // Django 传入，生产请改为你的域名

    document.getElementById('payload').textContent = JSON.stringify(payload, null, 2);

    document.getElementById('openBtn').addEventListener('click', () => {
      // 必须由用户触发 window.open，避免被 popup-blocker 拦截
      const w = window.open(targetUrl, '_blank');
      if (!w) {
        alert('浏览器阻止了弹出窗口，请允许弹窗或手动打开目标页面：' + targetUrl);
        return;
      }

      // 反复发送 postMessage（直到 injector.js 在目标页面就绪接收）
      let tries = 0;
      const maxTries = 15;
      const interval = setInterval(() => {
        try {
          if (w.closed || tries >= maxTries) {
            clearInterval(interval);
            return;
          }
          // 发送消息，第二个参数建议填具体 origin（安全）
          w.postMessage(payload, allowedOrigin);
          tries++;
        } catch (e) {
          console.error('postMessage error', e);
          clearInterval(interval);
        }
      }, 800);

      // 监听目标页面回执（injector.js 会把结果 postMessage 回 opener）
      window.addEventListener('message', (ev) => {
        // 校验来源 origin（安全）
        if (ev.origin !== allowedOrigin && allowedOrigin !== '*') {
          console.warn('忽略来自不可信 origin 的消息：', ev.origin);
          return;
        }
        const data = ev.data || {};
        // 仅显示来自插件/目标页面的特定回执
        if (data && data.source === 'server-trigger-reply') {
          document.getElementById('reply').textContent = JSON.stringify(data, null, 2);
        }
      });
    });
  </script>
</body>
</html>
